<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TON Payment</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            min-height: 100vh;
        }
        .container { max-width: 400px; margin: 0 auto; }
        h2 { margin-bottom: 20px; font-size: 24px; }
        .info-box {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        .info-row { display: flex; justify-content: space-between; margin: 8px 0; }
        .label { color: var(--tg-theme-hint-color, #999); }
        .value { font-weight: 600; }
        .tariff-info {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            border: 2px solid #0088cc;
        }
        .tariff-name {
            font-weight: 600;
            font-size: 18px;
            color: #0088cc;
        }
        .tariff-multiplier {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        #status {
            padding: 15px; border-radius: 12px; margin: 15px 0; text-align: center;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }
        button {
            width: 100%; padding: 15px; font-size: 16px; font-weight: 600;
            border: none; border-radius: 12px; cursor: pointer; margin: 10px 0;
        }
        #sendButton { background: #4CAF50; color: white; display: none; }
        #sendButton:hover { background: #45a049; }
        .address {
            word-break: break-all; font-family: monospace; font-size: 12px;
            background: rgba(0,0,0,0.05); padding: 8px; border-radius: 6px; margin-top: 5px;
        }
        #debug {
            margin-top: 20px; padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
            font-size: 12px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>üíé –û–ø–ª–∞—Ç–∞ TON</h2>
        
        <div class="info-box">
            <div class="label" style="margin-bottom: 10px;">–í–∞—à —Ç–∞—Ä–∏—Ñ:</div>
            <div class="tariff-info" id="tariff-display">
                <div class="tariff-name" id="tariff-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div class="tariff-multiplier" id="tariff-multiplier"></div>
            </div>
        </div>

        <div class="info-box">
            <div class="info-row">
                <span class="label">–ü–æ–ª—É—á–∞—Ç–µ–ª—å (–∫–æ–Ω—Ç—Ä–∞–∫—Ç):</span>
            </div>
            <div class="address" id="recipient"></div>
            <div class="info-row" style="margin-top: 15px;">
                <span class="label">–°—É–º–º–∞:</span>
                <span class="value" id="amount"></span>
            </div>
            <div class="info-row">
                <span class="label">ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:</span>
                <span class="value" id="external-id" style="font-family: monospace;"></span>
            </div>
        </div>

        <div id="status">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ –¥–ª—è –æ–ø–ª–∞—Ç—ã</div>
        <div id="ton-connect"></div>
        <button id="sendButton">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–ª–∞—Ç—ë–∂</button>
        <div id="debug"></div>
    </div>

    <script type="module">
        import { beginCell, Cell } from 'https://cdn.jsdelivr.net/npm/@ton/core@0.56.0/+esm';

        // ============================================
        // –ö–û–ù–°–¢–ê–ù–¢–´
        // ============================================
        const CONTRACT_ADDRESS = "EQDMrlaCpL9piz4So5lfvDn_Gyb10q6JkvrHSNCxtTxUvCiC";
        const GITHUB_USERNAME = "a-strelnikova";

        // ============================================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM WEBAPP
        // ============================================
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();
        
        // ‚úÖ –ü–û–ö–ê–ó–´–í–ê–ï–ú –ò –û–ë–†–ê–ë–ê–¢–´–í–ê–ï–ú –ö–ù–û–ü–ö–£ "–ù–ê–ó–ê–î"
        tg.BackButton.show();
        tg.BackButton.onClick(function() {
            console.log('üîô –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–ù–∞–∑–∞–¥", –∑–∞–∫—Ä—ã–≤–∞–µ–º WebApp...');
            tg.close();
        });

        const status = document.getElementById('status');
        const sendButton = document.getElementById('sendButton');
        const debugDiv = document.getElementById('debug');

        // ============================================
        // –ü–û–õ–£–ß–ï–ù–ò–ï –ü–ê–†–ê–ú–ï–¢–†–û–í –ò–ó URL
        // ============================================
        const urlParams = new URLSearchParams(window.location.search);
        const amount = urlParams.get('amount');
        const user_id = urlParams.get('user_id');
        const multiplier = urlParams.get('multiplier');
        const external_id = urlParams.get('external_id');

        console.log("üìù URL Params:", { amount, user_id, multiplier, external_id });

        document.getElementById('amount').textContent = `${amount} TON`;
        document.getElementById('recipient').textContent = CONTRACT_ADDRESS;
        document.getElementById('external-id').textContent = external_id;

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞
        const tariffValue = multiplier / 1000;
        let tariffName = "";
        if (multiplier == 1050) {
            tariffName = "–ê–∫—Ç–∏–≤–Ω—ã–π —Ç–∞—Ä–∏—Ñ";
        } else if (multiplier == 1030) {
            tariffName = "–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞—Ä–∏—Ñ";
        } else {
            tariffName = "–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ç–∞—Ä–∏—Ñ";
        }

        document.getElementById('tariff-name').textContent = tariffName;
        document.getElementById('tariff-multiplier').textContent = `√ó${tariffValue.toFixed(2)} –∫ —Å—É–º–º–µ –¥–µ–ø–æ–∑–∏—Ç–∞`;

        // ============================================
        // TON CONNECT –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // ============================================
        let tonConnectUI;
        let walletAddress = null;

        try {
            tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                manifestUrl: `https://${GITHUB_USERNAME}.github.io/ton-payment-bot/tonconnect-manifest.json`,
                buttonRootId: 'ton-connect'
            });

            tonConnectUI.uiOptions = {
                twaReturnUrl: 'https://t.me/blgpaybot'
            };

            console.log("‚úÖ TonConnect –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");

            tonConnectUI.onStatusChange((wallet) => {
                if (wallet) {
                    walletAddress = wallet.account.address;
                    status.textContent = `‚úÖ –ö–æ—à–µ–ª—ë–∫ –ø–æ–¥–∫–ª—é—á—ë–Ω: ${walletAddress.slice(0,8)}...${walletAddress.slice(-6)}`;
                    status.style.background = "#4CAF50";
                    sendButton.style.display = "block";
                    console.log("‚úÖ –ö–æ—à–µ–ª—ë–∫ –ø–æ–¥–∫–ª—é—á—ë–Ω:", walletAddress);
                    
                    // ‚úÖ –°–ö–†–´–í–ê–ï–ú –ö–ù–û–ü–ö–£ "–ù–ê–ó–ê–î" –ü–û–°–õ–ï –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø
                    tg.BackButton.hide();
                } else {
                    status.textContent = "–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ –¥–ª—è –æ–ø–ª–∞—Ç—ã";
                    status.style.background = "var(--tg-theme-secondary-bg-color, #f0f0f0)";
                    sendButton.style.display = "none";
                    walletAddress = null;
                    console.log("‚ùå –ö–æ—à–µ–ª—ë–∫ –æ—Ç–∫–ª—é—á—ë–Ω");
                    
                    // ‚úÖ –ü–û–ö–ê–ó–´–í–ê–ï–ú –ö–ù–û–ü–ö–£ "–ù–ê–ó–ê–î" –ï–°–õ–ò –û–¢–ö–õ–Æ–ß–ï–ù
                    tg.BackButton.show();
                }
            });

        } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ TonConnect:", error);
            status.textContent = "‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏";
            status.style.background = "#FF9800";
        }

        // ============================================
        // –û–¢–ü–†–ê–í–ö–ê –¢–†–ê–ù–ó–ê–ö–¶–ò–ò
        // ============================================
        sendButton.addEventListener('click', async () => {
            if (!walletAddress) {
                alert('‚ùå –ö–æ—à–µ–ª—ë–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω!');
                return;
            }

            console.log("üí∏ –ù–∞—á–∞–ª–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏...");
            status.textContent = "‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏...";
            sendButton.disabled = true;

            try {
                const amountNano = Math.floor(parseFloat(amount) * 1e9);
                console.log(`üí∞ –°—É–º–º–∞: ${amount} TON = ${amountNano} nanoTON`);

                // ‚úÖ –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å external_id
                const commentCell = beginCell()
                    .storeUint(0, 32)
                    .storeStringTail(external_id)
                    .endCell();

                console.log("üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:", external_id);

                const transaction = {
                    validUntil: Math.floor(Date.now() / 1000) + 300,
                    messages: [
                        {
                            address: CONTRACT_ADDRESS,
                            amount: amountNano.toString(),
                            payload: commentCell.toBoc().toString('base64')
                        }
                    ]
                };

                console.log("üì¶ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:", JSON.stringify(transaction, null, 2));

                const result = await tonConnectUI.sendTransaction(transaction);
                console.log("‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞:", result);

                const sentCell = Cell.fromBase64(result.boc);
                const hash = sentCell.hash().toString('base64');

                console.log("üîó Hash —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:", hash);

                const data = {
                    transactionTime: new Date().toLocaleString('ru-RU'),
                    amount: amount,
                    senderAddress: walletAddress,
                    recipient: CONTRACT_ADDRESS,
                    transactionHash: hash,
                    multiplier: multiplier,
                    external_id: external_id
                };

                console.log("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç–∞:", JSON.stringify(data, null, 2));

                tg.sendData(JSON.stringify(data));

                status.textContent = "‚úÖ –û–ø–ª–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ó–∞–∫—Ä—ã–≤–∞–µ–º...";
                status.style.background = "#4CAF50";

                setTimeout(() => {
                    console.log("üö™ –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp...");
                    tg.close();
                }, 1500);

            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:", error);
                status.textContent = "‚ùå –û—à–∏–±–∫–∞: " + (error.message || "–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞");
                status.style.background = "#f44336";
                sendButton.disabled = false;
                
                // ‚úÖ –ü–û–ö–ê–ó–´–í–ê–ï–ú –ö–ù–û–ü–ö–£ "–ù–ê–ó–ê–î" –ü–†–ò –û–®–ò–ë–ö–ï
                tg.BackButton.show();
            }
        });

    </script>
</body>
</html>
